<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="referrer" content="never">
    <title data-rh="true"></title>
    
    
    
    <meta name="description" content="xxx">
    <link rel="stylesheet" href="/assets/client-entry.9e72cc1b.css">
    <script type="importmap">
      {
        "imports": {
          "react": "/react.js","react-dom": "/react-dom.js","react-dom/client": "/react-dom_client.js","react/jsx-runtime": "/react_jsx-runtime.js"
        }
      }
    </script>
  </head>
  <body>
    <div id="root"><div><header fixed="~" pos="t-0 l-0" w="full" z="10"><div flex="~" items="center" justify="between" class="h-14 divider-bottom _nav_1qmqp_22"><div><a href="/" hover="opacity-60" class="w-full h-full text-1rem font-semibold flex items-center">Nasuke.js</a></div><div flex="~"><div flex="~"><div class="text-sm font-medium mx-3"><a href="/" class="_link_1qmqp_1">主页</a></div><div class="text-sm font-medium mx-3"><a href="/guide/" class="_link_1qmqp_1">指南</a></div></div><div before="menu-item-before" flex="~"><button class="_switch_8m5r4_1 undefined" id="" type="button" role="switch"><span class="_check_8m5r4_17"><span class="_icon_8m5r4_34"><div class="_sun_8m5r4_57"><div class="i-carbon-sun" w="full" h="full"></div></div><div class="_moon_8m5r4_61"><div class="i-carbon-moon" w="full" h="full"></div></div></span></span></button></div><div class="_social-link-icon_1qmqp_12" before="menu-item-before"><a href="/"><div class="i-carbon-logo-github w-5 h-5 fill-current"></div></a></div></div></div></header><section style="padding-top:var(--nasuke-nav-height)"><div p="t-0 x-6 b-24 sm:6" class="_docLayout_aof7m_8"><aside class="_sidebar_1q5rk_1"><nav><section block="~" not-first="divider-top mt-4"><div flex="~" justify="between" items="center"><h2 m="t-3 b-2" text="1rem text-1" font="bold">教程</h2></div><div mb="1"><div><div ml="5"><div p="1" block="~" text="sm" font-medium="~" class="text-text-2"><a href="/guide/a" target="" class="_link_kjpgb_1 ">MPA VS SPA</a></div></div></div><div><div ml="5"><div p="1" block="~" text="sm" font-medium="~" class="text-text-2"><a href="/guide/b" target="" class="_link_kjpgb_1 ">MDX</a></div></div></div><div><div ml="5"><div p="1" block="~" text="sm" font-medium="~" class="text-text-2"><a href="/guide/Counter" target="" class="_link_kjpgb_1 ">normal</a></div></div></div><div><div ml="5"><div p="1" block="~" text="sm" font-medium="~" class="text-brand"><a href="/guide/c" target="" class="_link_kjpgb_1 ">vite</a></div></div></div><div><div ml="5"><div p="1" block="~" text="sm" font-medium="~" class="text-text-2"><a href="/guide/d" target="" class="_link_kjpgb_1 ">test</a></div></div></div></div></section></nav></aside><div class="_content_aof7m_2" flex="~ 1 shrink-0" m="x-auto"><div m="x-auto" flex="~ col" class="max-w-100%"><div relative="~" m="x-auto" p="l-2" class="w-100% md:max-w-712px lg:min-w-640px"><div class="nasuke-doc"><p>在之前的双引擎架构中 了解到<strong>Vite开发阶段会模拟Rollup的行为</strong><strong>开发阶段Vite插件机制会有自己独有的一部分 并非与rollup完全兼容</strong><strong>兼容的钩子如下</strong></p>
<ul>
<li>服务器启动 - <code>options</code>和<code>buildStart</code></li>
<li>请求响应 - <code>resolveId``load``transform</code></li>
<li>服务器关闭 -<code>buildEnd closeBundle</code></li>
</ul>
<hr/>
<p></p>
<h2 id="vite插件系统中独有的hook"><a class="header-anchor" href="#vite插件系统中独有的hook">#</a>Vite插件系统中独有的hook</h2>
<hr/>
<p></p>
<h3 id="config---丰富配置"><a class="header-anchor" href="#config---丰富配置">#</a>config - 丰富配置</h3>
<p>时机: 在用户读取完<code>vite.config.ts</code> 拿到用户导出的配置对象后执行<code>config</code>钩子<!-- -->可以在其中对配置对象做自定义操作</p>
<div class="language-typescript"><span class="lang">typescript</span><pre class="shiki" style="background-color:#2e3440ff"><code><span class="line"><span style="color:#616E88">// 返回部分配置（推荐）</span></span>
<span class="line"><span style="color:#81A1C1">const</span><span style="color:#D8DEE9FF"> </span><span style="color:#88C0D0">editConfigPlugin</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">()</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=&gt;</span><span style="color:#D8DEE9FF"> (</span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#D8DEE9">name</span><span style="color:#ECEFF4">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">&#x27;</span><span style="color:#A3BE8C">vite-plugin-modify-config</span><span style="color:#ECEFF4">&#x27;</span><span style="color:#ECEFF4">,</span></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#88C0D0">config</span><span style="color:#ECEFF4">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">()</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=&gt;</span><span style="color:#D8DEE9FF"> (</span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#D8DEE9">alias</span><span style="color:#ECEFF4">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#D8DEE9FF">      </span><span style="color:#D8DEE9">react</span><span style="color:#ECEFF4">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">require</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">resolve</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">&#x27;</span><span style="color:#A3BE8C">react</span><span style="color:#ECEFF4">&#x27;</span><span style="color:#D8DEE9FF">)</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#ECEFF4">}</span></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#ECEFF4">}</span><span style="color:#D8DEE9FF">)</span></span>
<span class="line"><span style="color:#ECEFF4">}</span><span style="color:#D8DEE9FF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1">const</span><span style="color:#D8DEE9FF"> </span><span style="color:#88C0D0">mutateConfigPlugin</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">()</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=&gt;</span><span style="color:#D8DEE9FF"> (</span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#D8DEE9">name</span><span style="color:#ECEFF4">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">&#x27;</span><span style="color:#A3BE8C">mutate-config</span><span style="color:#ECEFF4">&#x27;</span><span style="color:#ECEFF4">,</span></span>
<span class="line"><span style="color:#ECEFF4">  </span><span style="color:#616E88">// command 为 `serve`(开发环境) 或者 `build`(生产环境)</span></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#88C0D0">config</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">config</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">command</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">})</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#ECEFF4">    </span><span style="color:#616E88">// 生产环境中修改 root 参数</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#81A1C1">if</span><span style="color:#D8DEE9FF"> (</span><span style="color:#D8DEE9">command</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">===</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">&#x27;</span><span style="color:#A3BE8C">build</span><span style="color:#ECEFF4">&#x27;</span><span style="color:#D8DEE9FF">) </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#D8DEE9FF">      </span><span style="color:#D8DEE9">config</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">root</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">__dirname</span><span style="color:#81A1C1">;</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#ECEFF4">}</span></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#ECEFF4">}</span></span>
<span class="line"><span style="color:#ECEFF4">}</span><span style="color:#D8DEE9FF">)</span></span>
<span class="line"></span></code></pre></div>
<p></p>
<h3 id="configresolved---记录最终配置"><a class="header-anchor" href="#configresolved---记录最终配置">#</a>configResolved - 记录最终配置</h3>
<p>用于记录信息以共享</p>
<div class="language-typescript"><span class="lang">typescript</span><pre class="shiki" style="background-color:#2e3440ff"><code><span class="line"><span style="color:#81A1C1">const</span><span style="color:#D8DEE9FF"> </span><span style="color:#88C0D0">exmaplePlugin</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">()</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=&gt;</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#81A1C1">let</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">config</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#81A1C1">return</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#D8DEE9">name</span><span style="color:#ECEFF4">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">&#x27;</span><span style="color:#A3BE8C">read-config</span><span style="color:#ECEFF4">&#x27;</span><span style="color:#ECEFF4">,</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#88C0D0">configResolved</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">resolvedConfig</span><span style="color:#ECEFF4">)</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#ECEFF4">      </span><span style="color:#616E88">// 记录最终配置</span></span>
<span class="line"><span style="color:#D8DEE9FF">      </span><span style="color:#D8DEE9">config</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">resolvedConfig</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#ECEFF4">},</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ECEFF4">    </span><span style="color:#616E88">// 在其他钩子中可以访问到配置</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#88C0D0">transform</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">code</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">id</span><span style="color:#ECEFF4">)</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#D8DEE9FF">      </span><span style="color:#D8DEE9">console</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">log</span><span style="color:#D8DEE9FF">(</span><span style="color:#D8DEE9">config</span><span style="color:#D8DEE9FF">)</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#ECEFF4">}</span></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#ECEFF4">}</span></span>
<span class="line"><span style="color:#ECEFF4">}</span></span>
<span class="line"></span></code></pre></div>
<p></p>
<h3 id="configureserver---获取devserver实例"><a class="header-anchor" href="#configureserver---获取devserver实例">#</a>configureServer - 获取DevServer实例</h3>
<p>用于拓展中间件 可以放到内置中间件之前或者之后执行</p>
<div class="language-typescript"><span class="lang">typescript</span><pre class="shiki" style="background-color:#2e3440ff"><code><span class="line"><span style="color:#81A1C1">const</span><span style="color:#D8DEE9FF"> </span><span style="color:#88C0D0">myPlugin</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">()</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=&gt;</span><span style="color:#D8DEE9FF"> (</span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#D8DEE9">name</span><span style="color:#ECEFF4">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">&#x27;</span><span style="color:#A3BE8C">configure-server</span><span style="color:#ECEFF4">&#x27;</span><span style="color:#ECEFF4">,</span></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#88C0D0">configureServer</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">server</span><span style="color:#ECEFF4">)</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#ECEFF4">    </span><span style="color:#616E88">// 姿势 1: 在 Vite 内置中间件之前执行</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#D8DEE9">server</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">middlewares</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">use</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">req</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">res</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">next</span><span style="color:#ECEFF4">)</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=&gt;</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#ECEFF4">      </span><span style="color:#616E88">// 自定义请求处理逻辑</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#ECEFF4">}</span><span style="color:#D8DEE9FF">)</span></span>
<span class="line"><span style="color:#ECEFF4">    </span><span style="color:#616E88">// 姿势 2: 在 Vite 内置中间件之后执行 </span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#81A1C1">return</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">()</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=&gt;</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#D8DEE9FF">      </span><span style="color:#D8DEE9">server</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">middlewares</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">use</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">req</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">res</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">next</span><span style="color:#ECEFF4">)</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=&gt;</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#ECEFF4">        </span><span style="color:#616E88">// 自定义请求处理逻辑</span></span>
<span class="line"><span style="color:#D8DEE9FF">      </span><span style="color:#ECEFF4">}</span><span style="color:#D8DEE9FF">)</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#ECEFF4">}</span></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#ECEFF4">}</span></span>
<span class="line"><span style="color:#ECEFF4">}</span><span style="color:#D8DEE9FF">)</span></span>
<span class="line"></span></code></pre></div>
<p></p>
<h3 id="transformindexhtml---控制html内容"><a class="header-anchor" href="#transformindexhtml---控制html内容">#</a>transformIndexHtml - 控制HTML内容</h3>
<p>拿到内容进行转换</p>
<div class="language-typescript"><span class="lang">typescript</span><pre class="shiki" style="background-color:#2e3440ff"><code><span class="line"><span style="color:#81A1C1">const</span><span style="color:#D8DEE9FF"> </span><span style="color:#88C0D0">htmlPlugin</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">()</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=&gt;</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#81A1C1">return</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#D8DEE9">name</span><span style="color:#ECEFF4">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">&#x27;</span><span style="color:#A3BE8C">html-transform</span><span style="color:#ECEFF4">&#x27;</span><span style="color:#ECEFF4">,</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#88C0D0">transformIndexHtml</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">html</span><span style="color:#ECEFF4">)</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#D8DEE9FF">      </span><span style="color:#81A1C1">return</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">html</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">replace</span><span style="color:#D8DEE9FF">(</span></span>
<span class="line"><span style="color:#D8DEE9FF">        </span><span style="color:#81A1C1">/&lt;</span><span style="color:#D8DEE9">title</span><span style="color:#81A1C1">&gt;</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">.</span><span style="color:#81A1C1">*?</span><span style="color:#D8DEE9FF">)</span><span style="color:#81A1C1">&lt;</span><span style="color:#ECEFF4">/</span><span style="color:#EBCB8B">title&gt;</span><span style="color:#ECEFF4">/</span><span style="color:#ECEFF4">,</span></span>
<span class="line"><span style="color:#D8DEE9FF">        </span><span style="color:#ECEFF4">`</span><span style="color:#A3BE8C">&lt;title&gt;换了个标题&lt;/title&gt;</span><span style="color:#ECEFF4">`</span></span>
<span class="line"><span style="color:#D8DEE9FF">      )</span></span>
<span class="line"><span style="color:#D8DEE9FF">    }</span></span>
<span class="line"><span style="color:#D8DEE9FF">  }</span></span>
<span class="line"><span style="color:#D8DEE9FF">}</span></span>
<span class="line"><span style="color:#616E88">// 也可以返回如下的对象结构，一般用于添加某些标签</span></span>
<span class="line"><span style="color:#D8DEE9">const</span><span style="color:#D8DEE9FF"> </span><span style="color:#88C0D0">htmlPlugin</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">()</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=&gt;</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#81A1C1">return</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#D8DEE9">name</span><span style="color:#ECEFF4">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">&#x27;</span><span style="color:#A3BE8C">html-transform</span><span style="color:#ECEFF4">&#x27;</span><span style="color:#ECEFF4">,</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#88C0D0">transformIndexHtml</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">html</span><span style="color:#ECEFF4">)</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#D8DEE9FF">      </span><span style="color:#81A1C1">return</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#D8DEE9FF">        </span><span style="color:#D8DEE9">html</span><span style="color:#ECEFF4">,</span></span>
<span class="line"><span style="color:#ECEFF4">        </span><span style="color:#616E88">// 注入标签</span></span>
<span class="line"><span style="color:#D8DEE9FF">        </span><span style="color:#D8DEE9">tags</span><span style="color:#ECEFF4">:</span><span style="color:#D8DEE9FF"> [</span></span>
<span class="line"><span style="color:#D8DEE9FF">          </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#ECEFF4">            </span><span style="color:#616E88">// 放到 body 末尾，可取值还有`head`|`head-prepend`|`body-prepend`，顾名思义</span></span>
<span class="line"><span style="color:#D8DEE9FF">            </span><span style="color:#D8DEE9">injectTo</span><span style="color:#ECEFF4">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">&#x27;</span><span style="color:#A3BE8C">body</span><span style="color:#ECEFF4">&#x27;</span><span style="color:#ECEFF4">,</span></span>
<span class="line"><span style="color:#ECEFF4">            </span><span style="color:#616E88">// 标签属性定义</span></span>
<span class="line"><span style="color:#D8DEE9FF">            </span><span style="color:#D8DEE9">attrs</span><span style="color:#ECEFF4">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">type</span><span style="color:#ECEFF4">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">&#x27;</span><span style="color:#A3BE8C">module</span><span style="color:#ECEFF4">&#x27;</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">src</span><span style="color:#ECEFF4">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">&#x27;</span><span style="color:#A3BE8C">./index.ts</span><span style="color:#ECEFF4">&#x27;</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">},</span></span>
<span class="line"><span style="color:#ECEFF4">            </span><span style="color:#616E88">// 标签名</span></span>
<span class="line"><span style="color:#D8DEE9FF">            </span><span style="color:#D8DEE9">tag</span><span style="color:#ECEFF4">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">&#x27;</span><span style="color:#A3BE8C">script</span><span style="color:#ECEFF4">&#x27;</span><span style="color:#ECEFF4">,</span></span>
<span class="line"><span style="color:#D8DEE9FF">          </span><span style="color:#ECEFF4">},</span></span>
<span class="line"><span style="color:#D8DEE9FF">        ]</span><span style="color:#ECEFF4">,</span></span>
<span class="line"><span style="color:#D8DEE9FF">      </span><span style="color:#ECEFF4">}</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#ECEFF4">}</span></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#ECEFF4">}</span></span>
<span class="line"><span style="color:#ECEFF4">}</span></span>
<span class="line"></span></code></pre></div>
<p></p>
<h3 id="handlehotupdate---热更新处理"><a class="header-anchor" href="#handlehotupdate---热更新处理">#</a>handleHotUpdate - 热更新处理</h3>
<p>可以拿到热更新相关的上下文 自定义处理</p>
<div class="language-typescript"><span class="lang">typescript</span><pre class="shiki" style="background-color:#2e3440ff"><code><span class="line"><span style="color:#81A1C1">const</span><span style="color:#D8DEE9FF"> </span><span style="color:#88C0D0">handleHmrPlugin</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">()</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=&gt;</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#81A1C1">return</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#81A1C1">async</span><span style="color:#D8DEE9FF"> </span><span style="color:#88C0D0">handleHotUpdate</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">ctx</span><span style="color:#ECEFF4">)</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#ECEFF4">      </span><span style="color:#616E88">// 需要热更的文件</span></span>
<span class="line"><span style="color:#D8DEE9FF">      </span><span style="color:#D8DEE9">console</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">log</span><span style="color:#D8DEE9FF">(</span><span style="color:#D8DEE9">ctx</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">file</span><span style="color:#D8DEE9FF">)</span></span>
<span class="line"><span style="color:#ECEFF4">      </span><span style="color:#616E88">// 需要热更的模块，如一个 Vue 单文件会涉及多个模块</span></span>
<span class="line"><span style="color:#D8DEE9FF">      </span><span style="color:#D8DEE9">console</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">log</span><span style="color:#D8DEE9FF">(</span><span style="color:#D8DEE9">ctx</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">modules</span><span style="color:#D8DEE9FF">)</span></span>
<span class="line"><span style="color:#ECEFF4">      </span><span style="color:#616E88">// 时间戳</span></span>
<span class="line"><span style="color:#D8DEE9FF">      </span><span style="color:#D8DEE9">console</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">log</span><span style="color:#D8DEE9FF">(</span><span style="color:#D8DEE9">ctx</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">timestamp</span><span style="color:#D8DEE9FF">)</span></span>
<span class="line"><span style="color:#ECEFF4">      </span><span style="color:#616E88">// Vite Dev Server 实例</span></span>
<span class="line"><span style="color:#D8DEE9FF">      </span><span style="color:#D8DEE9">console</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">log</span><span style="color:#D8DEE9FF">(</span><span style="color:#D8DEE9">ctx</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">server</span><span style="color:#D8DEE9FF">)</span></span>
<span class="line"><span style="color:#ECEFF4">      </span><span style="color:#616E88">// 读取最新的文件内容</span></span>
<span class="line"><span style="color:#D8DEE9FF">      </span><span style="color:#D8DEE9">console</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">log</span><span style="color:#D8DEE9FF">(</span><span style="color:#81A1C1">await</span><span style="color:#D8DEE9FF"> </span><span style="color:#88C0D0">read</span><span style="color:#D8DEE9FF">())</span></span>
<span class="line"><span style="color:#ECEFF4">      </span><span style="color:#616E88">// 自行处理 HMR 事件</span></span>
<span class="line"><span style="color:#D8DEE9FF">      </span><span style="color:#D8DEE9">ctx</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">server</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">ws</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">send</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#D8DEE9FF">        </span><span style="color:#D8DEE9">type</span><span style="color:#ECEFF4">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">&#x27;</span><span style="color:#A3BE8C">custom</span><span style="color:#ECEFF4">&#x27;</span><span style="color:#ECEFF4">,</span></span>
<span class="line"><span style="color:#D8DEE9FF">        </span><span style="color:#D8DEE9">event</span><span style="color:#ECEFF4">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">&#x27;</span><span style="color:#A3BE8C">special-update</span><span style="color:#ECEFF4">&#x27;</span><span style="color:#ECEFF4">,</span></span>
<span class="line"><span style="color:#D8DEE9FF">        </span><span style="color:#D8DEE9">data</span><span style="color:#ECEFF4">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">a</span><span style="color:#ECEFF4">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#B48EAD">1</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">}</span></span>
<span class="line"><span style="color:#D8DEE9FF">      </span><span style="color:#ECEFF4">}</span><span style="color:#D8DEE9FF">)</span></span>
<span class="line"><span style="color:#D8DEE9FF">      </span><span style="color:#81A1C1">return</span><span style="color:#D8DEE9FF"> []</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#ECEFF4">}</span></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#ECEFF4">}</span></span>
<span class="line"><span style="color:#ECEFF4">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88">// 前端代码中加入</span></span>
<span class="line"><span style="color:#81A1C1">if</span><span style="color:#D8DEE9FF"> (</span><span style="color:#81A1C1">import</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">meta</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">hot</span><span style="color:#D8DEE9FF">) </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#81A1C1">import</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">meta</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">hot</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">on</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">&#x27;</span><span style="color:#A3BE8C">special-update</span><span style="color:#ECEFF4">&#x27;</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">data</span><span style="color:#ECEFF4">)</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=&gt;</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#ECEFF4">    </span><span style="color:#616E88">// 执行自定义更新</span></span>
<span class="line"><span style="color:#ECEFF4">    </span><span style="color:#616E88">// { a: 1 }</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#D8DEE9">console</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">log</span><span style="color:#D8DEE9FF">(</span><span style="color:#D8DEE9">data</span><span style="color:#D8DEE9FF">)</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#D8DEE9">window</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">location</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">reload</span><span style="color:#D8DEE9FF">()</span><span style="color:#81A1C1">;</span></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#ECEFF4">}</span><span style="color:#D8DEE9FF">)</span></span>
<span class="line"><span style="color:#ECEFF4">}</span></span>
<span class="line"></span></code></pre></div>
<p></p>
<h2 id="插件执行顺序"><a class="header-anchor" href="#插件执行顺序">#</a>插件执行顺序</h2>
<hr/>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/12610297/1701077745248-8628582c-fead-4e1c-a320-5352c9a2b6ea.png#averageHue=%23faf9f8&amp;clientId=uac359372-5618-4&amp;from=paste&amp;height=688&amp;id=u35363d63&amp;originHeight=688&amp;originWidth=1618&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=174216&amp;status=done&amp;style=none&amp;taskId=u153c0f68-a03e-4544-acfc-cc3b17cbbd0&amp;title=&amp;width=1618" alt="image.png"/>
</p>
<h2 id="插件应用位置"><a class="header-anchor" href="#插件应用位置">#</a>插件应用位置</h2>
<p>环境<code>apply：string | function</code>  通过该属性可以决定插件生效环境</p>
<div class="language-typescript"><span class="lang">typescript</span><pre class="shiki" style="background-color:#2e3440ff"><code><span class="line"><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#ECEFF4">  </span><span style="color:#616E88">// &#x27;serve&#x27; 表示仅用于开发环境，&#x27;build&#x27;表示仅用于生产环境</span></span>
<span class="line"><span style="color:#D8DEE9FF">  apply</span><span style="color:#ECEFF4">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">&#x27;</span><span style="color:#A3BE8C">serve</span><span style="color:#ECEFF4">&#x27;</span></span>
<span class="line"><span style="color:#ECEFF4">}</span></span>
<span class="line"><span style="color:#616E88">// 配置函数更灵活</span></span>
<span class="line"><span style="color:#88C0D0">apply</span><span style="color:#D8DEE9FF">(</span><span style="color:#D8DEE9">config</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">command</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">}</span><span style="color:#D8DEE9FF">) </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#ECEFF4">  </span><span style="color:#616E88">// 只用于非 SSR 情况下的生产环境构建</span></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#81A1C1">return</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">command</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">===</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">&#x27;</span><span style="color:#A3BE8C">build</span><span style="color:#ECEFF4">&#x27;</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">&amp;&amp;</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">!</span><span style="color:#D8DEE9">config</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">build</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">ssr</span></span>
<span class="line"><span style="color:#ECEFF4">}</span></span>
<span class="line"></span></code></pre></div>
<p>顺序可以通过<code>enforce</code>来控制</p>
<div class="language-typescript"><span class="lang">typescript</span><pre class="shiki" style="background-color:#2e3440ff"><code><span class="line"><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#ECEFF4">  </span><span style="color:#616E88">// 默认为`normal`，可取值还有`pre`和`post`</span></span>
<span class="line"><span style="color:#D8DEE9FF">  enforce</span><span style="color:#ECEFF4">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">&#x27;</span><span style="color:#A3BE8C">pre</span><span style="color:#ECEFF4">&#x27;</span></span>
<span class="line"><span style="color:#ECEFF4">}</span></span>
<span class="line"></span></code></pre></div>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/12610297/1701078038154-1fab4c6f-227e-4d2d-b170-134b0e7c3ecd.png#averageHue=%23f7f4ed&amp;clientId=uac359372-5618-4&amp;from=paste&amp;height=430&amp;id=u369c2109&amp;originHeight=430&amp;originWidth=2746&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=223193&amp;status=done&amp;style=none&amp;taskId=u5efcb955-4ad7-4bb7-8211-b7f123b6549&amp;title=&amp;width=2746" alt="image.png"/>
</p>
<h2 id="实战"><a class="header-anchor" href="#实战">#</a>实战</h2>
<hr/>
<p></p>
<h3 id="虚拟模块"><a class="header-anchor" href="#虚拟模块">#</a>虚拟模块</h3>
<p>虚拟模块是一种很实用的模式 使你可以对使用 ESM 语法的源文件传入一些编译时信息<!-- -->它存在于内存中而非磁盘中<strong>我们可以手写代码字符串来作为模块内容</strong></p>
<div class="language-typescript"><span class="lang">typescript</span><pre class="shiki" style="background-color:#2e3440ff"><code><span class="line"><span style="color:#616E88">// vite.config.ts</span></span>
<span class="line"><span style="color:#81A1C1">import</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">virtual</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">from</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">&#x27;</span><span style="color:#A3BE8C">./plugins/virtual-module.ts</span><span style="color:#ECEFF4">&#x27;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88">// 配置插件</span></span>
<span class="line"><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#D8DEE9FF">  plugins</span><span style="color:#ECEFF4">:</span><span style="color:#D8DEE9FF"> [</span><span style="color:#88C0D0">react</span><span style="color:#D8DEE9FF">()</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9FF"> </span><span style="color:#88C0D0">virtual</span><span style="color:#D8DEE9FF">()]</span></span>
<span class="line"><span style="color:#ECEFF4">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88">// plugins/virtual-module.ts</span></span>
<span class="line"><span style="color:#81A1C1">import</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">Plugin</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">}</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">from</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">&#x27;</span><span style="color:#A3BE8C">vite</span><span style="color:#ECEFF4">&#x27;</span><span style="color:#81A1C1">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88">// 虚拟模块名称</span></span>
<span class="line"><span style="color:#81A1C1">const</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">virtualFibModuleId</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">&#x27;</span><span style="color:#A3BE8C">virtual:fib</span><span style="color:#ECEFF4">&#x27;</span><span style="color:#81A1C1">;</span></span>
<span class="line"><span style="color:#616E88">// Vite 中约定对于虚拟模块，解析后的路径需要加上`\0`前缀</span></span>
<span class="line"><span style="color:#81A1C1">const</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">resolvedFibVirtualModuleId</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">&#x27;</span><span style="color:#EBCB8B">\0</span><span style="color:#ECEFF4">&#x27;</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">+</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">virtualFibModuleId</span><span style="color:#81A1C1">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1">export</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">default</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">function</span><span style="color:#D8DEE9FF"> </span><span style="color:#88C0D0">virtualFibModulePlugin</span><span style="color:#ECEFF4">()</span><span style="color:#81A1C1">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">Plugin</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#81A1C1">let</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">config</span><span style="color:#81A1C1">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">ResolvedConfig</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">|</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">null</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">null;</span></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#81A1C1">return</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#D8DEE9">name</span><span style="color:#ECEFF4">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">&#x27;</span><span style="color:#A3BE8C">vite-plugin-virtual-module</span><span style="color:#ECEFF4">&#x27;</span><span style="color:#ECEFF4">,</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#88C0D0">resolveId</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">id</span><span style="color:#ECEFF4">)</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#D8DEE9FF">      </span><span style="color:#81A1C1">if</span><span style="color:#D8DEE9FF"> (</span><span style="color:#D8DEE9">id</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">===</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">virtualFibModuleId</span><span style="color:#D8DEE9FF">) </span><span style="color:#ECEFF4">{</span><span style="color:#D8DEE9FF"> </span></span>
<span class="line"><span style="color:#D8DEE9FF">        </span><span style="color:#81A1C1">return</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">resolvedFibVirtualModuleId</span><span style="color:#81A1C1">;</span></span>
<span class="line"><span style="color:#D8DEE9FF">      </span><span style="color:#ECEFF4">}</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#ECEFF4">},</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#88C0D0">load</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">id</span><span style="color:#ECEFF4">)</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#ECEFF4">      </span><span style="color:#616E88">// 加载虚拟模块</span></span>
<span class="line"><span style="color:#D8DEE9FF">      </span><span style="color:#81A1C1">if</span><span style="color:#D8DEE9FF"> (</span><span style="color:#D8DEE9">id</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">===</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">resolvedFibVirtualModuleId</span><span style="color:#D8DEE9FF">) </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#D8DEE9FF">        </span><span style="color:#81A1C1">return</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">&#x27;</span><span style="color:#A3BE8C">export default function fib(n) { return n &lt;= 1 ? n : fib(n - 1) + fib(n - 2); }</span><span style="color:#ECEFF4">&#x27;</span><span style="color:#81A1C1">;</span></span>
<span class="line"><span style="color:#D8DEE9FF">      </span><span style="color:#ECEFF4">}</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#ECEFF4">}</span></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#ECEFF4">}</span></span>
<span class="line"><span style="color:#ECEFF4">}</span></span>
<span class="line"></span></code></pre></div>
<hr/>
<p></p>
<h2 id="vite热更新"><a class="header-anchor" href="#vite热更新">#</a>Vite热更新</h2>
<p>计算机领域有一个热拔插的概念<!-- -->当我们插入U盘时 系统驱动会加载U盘内容 但是不会重启系统<!-- -->HMR概念也是这样 <code>模块局部更新</code> + <code>状态保存</code>Vite的HMR系统基于元素的ESM模块规范来实现<!-- -->这是HMR API定义</p>
<div class="language-typescript"><span class="lang">typescript</span><pre class="shiki" style="background-color:#2e3440ff"><code><span class="line"><span style="color:#81A1C1">interface</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">ImportMeta</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#81A1C1">readonly</span><span style="color:#D8DEE9FF"> hot</span><span style="color:#81A1C1">?:</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#81A1C1">readonly</span><span style="color:#D8DEE9FF"> data</span><span style="color:#81A1C1">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">any</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#88C0D0">accept</span><span style="color:#ECEFF4">()</span><span style="color:#81A1C1">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">void</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#88C0D0">accept</span><span style="color:#ECEFF4">(</span><span style="color:#88C0D0">cb</span><span style="color:#81A1C1">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">mod</span><span style="color:#81A1C1">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">any</span><span style="color:#ECEFF4">)</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=&gt;</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">void</span><span style="color:#ECEFF4">)</span><span style="color:#81A1C1">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">void</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#88C0D0">accept</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">dep</span><span style="color:#81A1C1">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">string</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9FF"> </span><span style="color:#88C0D0">cb</span><span style="color:#81A1C1">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">mod</span><span style="color:#81A1C1">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">any</span><span style="color:#ECEFF4">)</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=&gt;</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">void</span><span style="color:#ECEFF4">)</span><span style="color:#81A1C1">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">void</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#88C0D0">accept</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">deps</span><span style="color:#81A1C1">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">string</span><span style="color:#D8DEE9FF">[]</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9FF"> </span><span style="color:#88C0D0">cb</span><span style="color:#81A1C1">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">mods</span><span style="color:#81A1C1">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">any</span><span style="color:#D8DEE9FF">[]</span><span style="color:#ECEFF4">)</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=&gt;</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">void</span><span style="color:#ECEFF4">)</span><span style="color:#81A1C1">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">void</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#88C0D0">prune</span><span style="color:#ECEFF4">(</span><span style="color:#88C0D0">cb</span><span style="color:#81A1C1">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">()</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=&gt;</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">void</span><span style="color:#ECEFF4">)</span><span style="color:#81A1C1">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">void</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#88C0D0">dispose</span><span style="color:#ECEFF4">(</span><span style="color:#88C0D0">cb</span><span style="color:#81A1C1">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">data</span><span style="color:#81A1C1">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">any</span><span style="color:#ECEFF4">)</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=&gt;</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">void</span><span style="color:#ECEFF4">)</span><span style="color:#81A1C1">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">void</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#88C0D0">decline</span><span style="color:#ECEFF4">()</span><span style="color:#81A1C1">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">void</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#88C0D0">invalidate</span><span style="color:#ECEFF4">()</span><span style="color:#81A1C1">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">void</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#88C0D0">on</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">event</span><span style="color:#81A1C1">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">string</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9FF"> </span><span style="color:#88C0D0">cb</span><span style="color:#81A1C1">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">(</span><span style="color:#81A1C1">...</span><span style="color:#D8DEE9">args</span><span style="color:#81A1C1">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">any</span><span style="color:#D8DEE9FF">[]</span><span style="color:#ECEFF4">)</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=&gt;</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">void</span><span style="color:#ECEFF4">)</span><span style="color:#81A1C1">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">void</span></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#ECEFF4">}</span></span>
<span class="line"><span style="color:#ECEFF4">}</span></span>
<span class="line"></span></code></pre></div>
<p></p>
<h3 id="更新逻辑-hotaccept"><a class="header-anchor" href="#更新逻辑-hotaccept">#</a>更新逻辑 <code>hot.accept</code></h3>
<p>该方法决定了热更新的边界 <strong>边界即是可以处理事件回调的范围</strong>当前模块可以使用该方法接受模块更新 有三种情况</p>
<ul>
<li>自身模块</li>
<li>某个子模块</li>
<li>多个子模块</li>
</ul>
<p>当接受自身更新时 边界在自身 回调函数在自身编写 其它模块没有影响<!-- -->当接受子模块更新时 边界在父模块 即编写回调函数的地方<!-- -->多个子模块同理</p>
<div class="language-typescript"><span class="lang">typescript</span><pre class="shiki" style="background-color:#2e3440ff"><code><span class="line"><span style="color:#616E88">// 条件守卫 自身</span></span>
<span class="line"><span style="color:#81A1C1">+</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">if</span><span style="color:#D8DEE9FF"> (</span><span style="color:#81A1C1">import</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">meta</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">hot</span><span style="color:#D8DEE9FF">) </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#81A1C1">+</span><span style="color:#D8DEE9FF">  </span><span style="color:#81A1C1">import</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">meta</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">hot</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">accept</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">mod</span><span style="color:#ECEFF4">)</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=&gt;</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">mod</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">render</span><span style="color:#D8DEE9FF">())</span></span>
<span class="line"><span style="color:#81A1C1">+</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88">// main.ts 单个模块</span></span>
<span class="line"><span style="color:#81A1C1">import</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">render</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">}</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">from</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">&#x27;</span><span style="color:#A3BE8C">./render</span><span style="color:#ECEFF4">&#x27;</span><span style="color:#81A1C1">;</span></span>
<span class="line"><span style="color:#81A1C1">import</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">&#x27;</span><span style="color:#A3BE8C">./state</span><span style="color:#ECEFF4">&#x27;</span><span style="color:#81A1C1">;</span></span>
<span class="line"><span style="color:#88C0D0">render</span><span style="color:#D8DEE9FF">()</span><span style="color:#81A1C1">;</span></span>
<span class="line"><span style="color:#81A1C1">+if</span><span style="color:#D8DEE9FF"> (</span><span style="color:#81A1C1">import</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">meta</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">hot</span><span style="color:#D8DEE9FF">) </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#81A1C1">+</span><span style="color:#D8DEE9FF">  </span><span style="color:#81A1C1">import</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">meta</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">hot</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">accept</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">&#x27;</span><span style="color:#A3BE8C">./render.ts</span><span style="color:#ECEFF4">&#x27;</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">newModule</span><span style="color:#ECEFF4">)</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=&gt;</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#81A1C1">+</span><span style="color:#D8DEE9FF">    </span><span style="color:#D8DEE9">newModule</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">render</span><span style="color:#D8DEE9FF">()</span><span style="color:#81A1C1">;</span></span>
<span class="line"><span style="color:#81A1C1">+</span><span style="color:#D8DEE9FF">  </span><span style="color:#ECEFF4">}</span><span style="color:#D8DEE9FF">)</span></span>
<span class="line"><span style="color:#81A1C1">+</span><span style="color:#ECEFF4">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88">// main.ts 多个模块</span></span>
<span class="line"><span style="color:#81A1C1">import</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">render</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">}</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">from</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">&#x27;</span><span style="color:#A3BE8C">./render</span><span style="color:#ECEFF4">&#x27;</span><span style="color:#81A1C1">;</span></span>
<span class="line"><span style="color:#81A1C1">import</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">initState</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">}</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">from</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">&#x27;</span><span style="color:#A3BE8C">./state</span><span style="color:#ECEFF4">&#x27;</span><span style="color:#81A1C1">;</span></span>
<span class="line"><span style="color:#88C0D0">render</span><span style="color:#D8DEE9FF">()</span><span style="color:#81A1C1">;</span></span>
<span class="line"><span style="color:#88C0D0">initState</span><span style="color:#D8DEE9FF">()</span><span style="color:#81A1C1">;</span></span>
<span class="line"><span style="color:#81A1C1">+if</span><span style="color:#D8DEE9FF"> (</span><span style="color:#81A1C1">import</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">meta</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">hot</span><span style="color:#D8DEE9FF">) </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#81A1C1">+</span><span style="color:#D8DEE9FF">  </span><span style="color:#81A1C1">import</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">meta</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">hot</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">accept</span><span style="color:#D8DEE9FF">([</span><span style="color:#ECEFF4">&#x27;</span><span style="color:#A3BE8C">./render.ts</span><span style="color:#ECEFF4">&#x27;</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">&#x27;</span><span style="color:#A3BE8C">./state.ts</span><span style="color:#ECEFF4">&#x27;</span><span style="color:#D8DEE9FF">]</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">modules</span><span style="color:#ECEFF4">)</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=&gt;</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#81A1C1">+</span><span style="color:#D8DEE9FF">    </span><span style="color:#D8DEE9">console</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">log</span><span style="color:#D8DEE9FF">(</span><span style="color:#D8DEE9">modules</span><span style="color:#D8DEE9FF">)</span><span style="color:#81A1C1">;</span></span>
<span class="line"><span style="color:#81A1C1">+</span><span style="color:#D8DEE9FF">  </span><span style="color:#ECEFF4">}</span><span style="color:#D8DEE9FF">)</span></span>
<span class="line"><span style="color:#81A1C1">+</span><span style="color:#ECEFF4">}</span></span>
<span class="line"></span>
<span class="line"></span></code></pre></div>
<p>注意这里条件守卫的使用 <strong>该操作是为了生产环境的树摇</strong>
</p>
<h3 id="旧模块销毁处理副作用-hotdispose"><a class="header-anchor" href="#旧模块销毁处理副作用-hotdispose">#</a>旧模块销毁处理副作用 <code>hot.dispose</code></h3>
<hr/>
<p>旧模块销毁 模块更新时可以使用它做一些副作用清除操作 如销毁定时器</p>
<div class="language-typescript"><span class="lang">typescript</span><pre class="shiki" style="background-color:#2e3440ff"><code><span class="line"><span style="color:#616E88">// state.ts</span></span>
<span class="line"><span style="color:#81A1C1">let</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">timer</span><span style="color:#81A1C1">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">number</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">|</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">undefined</span><span style="color:#81A1C1">;</span></span>
<span class="line"><span style="color:#81A1C1">if</span><span style="color:#D8DEE9FF"> (</span><span style="color:#81A1C1">import</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">meta</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">hot</span><span style="color:#D8DEE9FF">) </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#81A1C1">import</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">meta</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">hot</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">dispose</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">()</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=&gt;</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#81A1C1">if</span><span style="color:#D8DEE9FF"> (</span><span style="color:#D8DEE9">timer</span><span style="color:#D8DEE9FF">) </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#D8DEE9FF">      </span><span style="color:#88C0D0">clearInterval</span><span style="color:#D8DEE9FF">(</span><span style="color:#D8DEE9">timer</span><span style="color:#D8DEE9FF">)</span><span style="color:#81A1C1">;</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#ECEFF4">}</span></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#ECEFF4">}</span><span style="color:#D8DEE9FF">)</span></span>
<span class="line"><span style="color:#ECEFF4">}</span></span>
<span class="line"><span style="color:#81A1C1">export</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">function</span><span style="color:#D8DEE9FF"> </span><span style="color:#88C0D0">initState</span><span style="color:#ECEFF4">()</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#81A1C1">let</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">count</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> </span><span style="color:#B48EAD">0</span><span style="color:#81A1C1">;</span></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#D8DEE9">timer</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> </span><span style="color:#88C0D0">setInterval</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">()</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=&gt;</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#81A1C1">let</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">countEle</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">document</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">getElementById</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">&#x27;</span><span style="color:#A3BE8C">count</span><span style="color:#ECEFF4">&#x27;</span><span style="color:#D8DEE9FF">)</span><span style="color:#81A1C1">;</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#D8DEE9">countEle</span><span style="color:#81A1C1">!</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">innerText</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF">  </span><span style="color:#81A1C1">++</span><span style="color:#D8DEE9">count</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">+</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">&#x27;&#x27;</span><span style="color:#81A1C1">;</span></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#ECEFF4">},</span><span style="color:#D8DEE9FF"> </span><span style="color:#B48EAD">1000</span><span style="color:#D8DEE9FF">)</span><span style="color:#81A1C1">;</span></span>
<span class="line"><span style="color:#ECEFF4">}</span></span>
<span class="line"></span>
<span class="line"></span></code></pre></div>
<p></p>
<h3 id="共享数据-hotdata"><a class="header-anchor" href="#共享数据-hotdata">#</a>共享数据 <code>hot.data</code></h3>
<hr/>
<p>用于在不同模块实例共享数据</p>
<p></p>
<h2 id="vite产物构建"><a class="header-anchor" href="#vite产物构建">#</a>Vite产物构建</h2>
<p><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/12610297/1701142983497-b80ce66a-9507-4082-a11a-6bd4049d26fa.jpeg" alt=""/>
</p>
<h3 id="vite默认拆包策略"><a class="header-anchor" href="#vite默认拆包策略">#</a>Vite默认拆包策略</h3>
<p>自动CSS分割 一个chunk对应一个css文件</p>
<div class="language-typescript"><span class="lang">typescript</span><pre class="shiki" style="background-color:#2e3440ff"><code><span class="line"><span style="color:#ECEFF4">.</span></span>
<span class="line"><span style="color:#D8DEE9FF">├── </span><span style="color:#D8DEE9">assets</span></span>
<span class="line"><span style="color:#D8DEE9FF">│   ├── </span><span style="color:#D8DEE9">Dynamic</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9FF">3</span><span style="color:#D8DEE9">df51f7a</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">js</span><span style="color:#D8DEE9FF">    </span><span style="color:#616E88">// Async Chunk</span></span>
<span class="line"><span style="color:#D8DEE9FF">│   ├── </span><span style="color:#D8DEE9">Dynamic</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">f2cbf023</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">css</span><span style="color:#D8DEE9FF">   </span><span style="color:#616E88">// Async Chunk (CSS)</span></span>
<span class="line"><span style="color:#D8DEE9FF">│   ├── </span><span style="color:#D8DEE9">favicon</span><span style="color:#ECEFF4">.</span><span style="color:#B48EAD">17e50649</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">svg</span><span style="color:#D8DEE9FF">   </span><span style="color:#616E88">// 静态资源</span></span>
<span class="line"><span style="color:#D8DEE9FF">│   ├── </span><span style="color:#D8DEE9">index</span><span style="color:#ECEFF4">.</span><span style="color:#B48EAD">1e236845</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">css</span><span style="color:#D8DEE9FF">     </span><span style="color:#616E88">// Initial Chunk (CSS)</span></span>
<span class="line"><span style="color:#D8DEE9FF">│   ├── </span><span style="color:#D8DEE9">index</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9FF">6773</span><span style="color:#D8DEE9">c114</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">js</span><span style="color:#D8DEE9FF">      </span><span style="color:#616E88">// Initial Chunk</span></span>
<span class="line"><span style="color:#D8DEE9FF">│   └── </span><span style="color:#D8DEE9">vendor</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">ab4b9e1f</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">js</span><span style="color:#D8DEE9FF">     </span><span style="color:#616E88">// 第三方包产物 Chunk 2.9以后默认不单独打包</span></span>
<span class="line"><span style="color:#D8DEE9FF">└── </span><span style="color:#D8DEE9">index</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">html</span><span style="color:#D8DEE9FF">                 </span><span style="color:#616E88">// 入口 HTML</span></span>
<span class="line"></span></code></pre></div>
<p>基于Rollup<code>manualChunks</code>实现应用拆包</p>
<ul>
<li><code>Async Chunk</code> 动态的import会变成单独的chunk</li>
<li><code>Initial Chunk</code>和第三方库代码会打包到一起</li>
<li>也可以使用插件来沿用2.8版本之前的分割三方库代码策略</li>
</ul>
<div class="language-typescript"><span class="lang">typescript</span><pre class="shiki" style="background-color:#2e3440ff"><code><span class="line"><span style="color:#616E88">// vite.config.js</span></span>
<span class="line"><span style="color:#81A1C1">import</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">splitVendorChunkPlugin</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">}</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">from</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">&#x27;</span><span style="color:#A3BE8C">vite</span><span style="color:#ECEFF4">&#x27;</span></span>
<span class="line"><span style="color:#81A1C1">export</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">default</span><span style="color:#D8DEE9FF"> </span><span style="color:#88C0D0">defineConfig</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#D8DEE9">plugins</span><span style="color:#ECEFF4">:</span><span style="color:#D8DEE9FF"> [</span><span style="color:#88C0D0">splitVendorChunkPlugin</span><span style="color:#D8DEE9FF">()]</span><span style="color:#ECEFF4">,</span></span>
<span class="line"><span style="color:#ECEFF4">}</span><span style="color:#D8DEE9FF">)</span></span>
<span class="line"></span></code></pre></div>
<p></p>
<h3 id="自定义拆包"><a class="header-anchor" href="#自定义拆包">#</a>自定义拆包</h3>
<p>自定义拆包可以让我们操作更细粒 <strong>提高第三方包产物的缓存命中率</strong>可以通过配置对象或者函数的两种方式</p>
<div class="language-typescript"><span class="lang">typescript</span><pre class="shiki" style="background-color:#2e3440ff"><code><span class="line"><span style="color:#616E88">// vite.config.ts</span></span>
<span class="line"><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#D8DEE9FF">  build</span><span style="color:#ECEFF4">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#D8DEE9FF">    rollupOptions</span><span style="color:#ECEFF4">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#D8DEE9FF">      output</span><span style="color:#ECEFF4">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#ECEFF4">        </span><span style="color:#616E88">// manualChunks 配置</span></span>
<span class="line"><span style="color:#D8DEE9FF">        manualChunks</span><span style="color:#ECEFF4">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#ECEFF4">          </span><span style="color:#616E88">// 将 React 相关库打包成单独的 chunk 中</span></span>
<span class="line"><span style="color:#D8DEE9FF">          </span><span style="color:#ECEFF4">&#x27;</span><span style="color:#A3BE8C">react-vendor</span><span style="color:#ECEFF4">&#x27;</span><span style="color:#D8DEE9FF">: [</span><span style="color:#ECEFF4">&#x27;</span><span style="color:#A3BE8C">react</span><span style="color:#ECEFF4">&#x27;</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">&#x27;</span><span style="color:#A3BE8C">react-dom</span><span style="color:#ECEFF4">&#x27;</span><span style="color:#D8DEE9FF">]</span><span style="color:#ECEFF4">,</span></span>
<span class="line"><span style="color:#ECEFF4">          </span><span style="color:#616E88">// 将 Lodash 库的代码单独打包</span></span>
<span class="line"><span style="color:#D8DEE9FF">          </span><span style="color:#ECEFF4">&#x27;</span><span style="color:#A3BE8C">lodash</span><span style="color:#ECEFF4">&#x27;</span><span style="color:#D8DEE9FF">: [</span><span style="color:#ECEFF4">&#x27;</span><span style="color:#A3BE8C">lodash-es</span><span style="color:#ECEFF4">&#x27;</span><span style="color:#D8DEE9FF">]</span><span style="color:#ECEFF4">,</span></span>
<span class="line"><span style="color:#ECEFF4">          </span><span style="color:#616E88">// 将组件库的代码打包</span></span>
<span class="line"><span style="color:#D8DEE9FF">          </span><span style="color:#ECEFF4">&#x27;</span><span style="color:#A3BE8C">library</span><span style="color:#ECEFF4">&#x27;</span><span style="color:#D8DEE9FF">: [</span><span style="color:#ECEFF4">&#x27;</span><span style="color:#A3BE8C">antd</span><span style="color:#ECEFF4">&#x27;</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">&#x27;</span><span style="color:#A3BE8C">@arco-design/web-react</span><span style="color:#ECEFF4">&#x27;</span><span style="color:#D8DEE9FF">]</span><span style="color:#ECEFF4">,</span></span>
<span class="line"><span style="color:#D8DEE9FF">        </span><span style="color:#ECEFF4">},</span></span>
<span class="line"><span style="color:#D8DEE9FF">      </span><span style="color:#ECEFF4">},</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#ECEFF4">}</span></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#ECEFF4">},</span></span>
<span class="line"><span style="color:#ECEFF4">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88">// 入参为模块id 模块详细信息 返回值为chunk文件名称</span></span>
<span class="line"><span style="color:#88C0D0">manualChunks</span><span style="color:#D8DEE9FF">(</span><span style="color:#D8DEE9">id</span><span style="color:#D8DEE9FF">) </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#81A1C1">if</span><span style="color:#D8DEE9FF"> (</span><span style="color:#D8DEE9">id</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">includes</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">&#x27;</span><span style="color:#A3BE8C">antd</span><span style="color:#ECEFF4">&#x27;</span><span style="color:#D8DEE9FF">) </span><span style="color:#81A1C1">||</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">id</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">includes</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">&#x27;</span><span style="color:#A3BE8C">@arco-design/web-react</span><span style="color:#ECEFF4">&#x27;</span><span style="color:#D8DEE9FF">)) </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#81A1C1">return</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">&#x27;</span><span style="color:#A3BE8C">library</span><span style="color:#ECEFF4">&#x27;</span><span style="color:#81A1C1">;</span></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#ECEFF4">}</span></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#81A1C1">if</span><span style="color:#D8DEE9FF"> (</span><span style="color:#D8DEE9">id</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">includes</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">&#x27;</span><span style="color:#A3BE8C">lodash</span><span style="color:#ECEFF4">&#x27;</span><span style="color:#D8DEE9FF">)) </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#81A1C1">return</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">&#x27;</span><span style="color:#A3BE8C">lodash</span><span style="color:#ECEFF4">&#x27;</span><span style="color:#81A1C1">;</span></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#ECEFF4">}</span></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#81A1C1">if</span><span style="color:#D8DEE9FF"> (</span><span style="color:#D8DEE9">id</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">includes</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">&#x27;</span><span style="color:#A3BE8C">react</span><span style="color:#ECEFF4">&#x27;</span><span style="color:#D8DEE9FF">)) </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#81A1C1">return</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">&#x27;</span><span style="color:#A3BE8C">react</span><span style="color:#ECEFF4">&#x27;</span><span style="color:#81A1C1">;</span></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#ECEFF4">}</span></span>
<span class="line"><span style="color:#ECEFF4">}</span></span>
<span class="line"></span></code></pre></div>
<p></p>
<h3 id="解决循环依赖"><a class="header-anchor" href="#解决循环依赖">#</a>解决循环依赖</h3>
<p>图示<img src="https://cdn.nlark.com/yuque/0/2023/png/12610297/1701152438133-cdd8fb53-d011-460f-8b6e-c8aa5da530b1.png#averageHue=%23f8f8f1&amp;clientId=ufbb7c4de-f17a-4&amp;from=paste&amp;height=664&amp;id=u5f2edad1&amp;originHeight=664&amp;originWidth=2404&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=169847&amp;status=done&amp;style=none&amp;taskId=udfe81f5d-c5c5-4175-bfe1-1cbdb2b9a8d&amp;title=&amp;width=2404" alt="image.png"/>这会导致报错 <code>xxx is not a function</code>因为循环依赖导致后者认为前者已经加载完了 继续执行就会出现问题<!-- -->解决思路</p>
<ul>
<li>确定相关包的入口路径</li>
<li><code>manualChunks</code>函数中拿到模块详细信息 追溯其引用者 如果命中路径 则模块打包到该路径</li>
</ul>
<div class="language-typescript"><span class="lang">typescript</span><pre class="shiki" style="background-color:#2e3440ff"><code><span class="line"><span style="color:#616E88">// 确定 react 相关包的入口路径</span></span>
<span class="line"><span style="color:#81A1C1">const</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">chunkGroups</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#ECEFF4">&#x27;</span><span style="color:#A3BE8C">react-vendor</span><span style="color:#ECEFF4">&#x27;</span><span style="color:#ECEFF4">:</span><span style="color:#D8DEE9FF"> [</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#D8DEE9">require</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">resolve</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">&#x27;</span><span style="color:#A3BE8C">react</span><span style="color:#ECEFF4">&#x27;</span><span style="color:#D8DEE9FF">)</span><span style="color:#ECEFF4">,</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#D8DEE9">require</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">resolve</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">&#x27;</span><span style="color:#A3BE8C">react-dom</span><span style="color:#ECEFF4">&#x27;</span><span style="color:#D8DEE9FF">)</span></span>
<span class="line"><span style="color:#D8DEE9FF">  ]</span><span style="color:#ECEFF4">,</span></span>
<span class="line"><span style="color:#ECEFF4">}</span><span style="color:#81A1C1">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88">// Vite 中的 manualChunks 配置</span></span>
<span class="line"><span style="color:#616E88">// 根据传入的模块id和getModuleInfo函数，查找是否有循环依赖，并返回对应的分组</span></span>
<span class="line"><span style="color:#81A1C1">function</span><span style="color:#D8DEE9FF"> </span><span style="color:#88C0D0">manualChunks</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">id</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">getModuleInfo</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">})</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#ECEFF4">  </span><span style="color:#616E88">// 遍历所有的分组</span></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#81A1C1">for</span><span style="color:#D8DEE9FF"> (</span><span style="color:#81A1C1">const</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">group</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">of</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">Object</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">keys</span><span style="color:#D8DEE9FF">(</span><span style="color:#D8DEE9">chunkGroups</span><span style="color:#D8DEE9FF">)) </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#81A1C1">const</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">deps</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">chunkGroups</span><span style="color:#D8DEE9FF">[</span><span style="color:#D8DEE9">group</span><span style="color:#D8DEE9FF">]</span><span style="color:#81A1C1">;</span></span>
<span class="line"><span style="color:#ECEFF4">    </span><span style="color:#616E88">// 判断模块id是否在node_modules中并且被chunkGroups声明的包所引用</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#81A1C1">if</span><span style="color:#D8DEE9FF"> (</span></span>
<span class="line"><span style="color:#D8DEE9FF">      </span><span style="color:#D8DEE9">id</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">includes</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">&#x27;</span><span style="color:#A3BE8C">node_modules</span><span style="color:#ECEFF4">&#x27;</span><span style="color:#D8DEE9FF">) </span><span style="color:#81A1C1">&amp;&amp;</span></span>
<span class="line"><span style="color:#ECEFF4">      </span><span style="color:#616E88">// 递归向上查找引用者，检查是否命中 chunkGroups 声明的包 </span></span>
<span class="line"><span style="color:#D8DEE9FF">      </span><span style="color:#88C0D0">isDepInclude</span><span style="color:#D8DEE9FF">(</span><span style="color:#D8DEE9">id</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">deps</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9FF"> []</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">getModuleInfo</span><span style="color:#D8DEE9FF">)</span></span>
<span class="line"><span style="color:#D8DEE9FF">     ) </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#D8DEE9FF">      </span><span style="color:#81A1C1">return</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">group</span><span style="color:#81A1C1">;</span><span style="color:#D8DEE9FF"> </span><span style="color:#616E88">// 返回对应的分组</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#ECEFF4">}</span></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#ECEFF4">}</span></span>
<span class="line"><span style="color:#ECEFF4">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88">// 缓存对象，用于记录已经验证过的依赖路径</span></span>
<span class="line"><span style="color:#81A1C1">const</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">cache</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">new</span><span style="color:#D8DEE9FF"> </span><span style="color:#88C0D0">Map</span><span style="color:#D8DEE9FF">()</span><span style="color:#81A1C1">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88">// 判断给定的id是否在依赖路径depPaths中，并检查是否存在循环依赖</span></span>
<span class="line"><span style="color:#81A1C1">function</span><span style="color:#D8DEE9FF"> </span><span style="color:#88C0D0">isDepInclude</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">id</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">depPaths</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">importChain</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">getModuleInfo</span><span style="color:#ECEFF4">)</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#81A1C1">const</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">key</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">`${</span><span style="color:#D8DEE9">id</span><span style="color:#ECEFF4">}</span><span style="color:#A3BE8C">-</span><span style="color:#ECEFF4">${</span><span style="color:#D8DEE9">depPaths</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">join</span><span style="color:#ECEFF4">(</span><span style="color:#ECEFF4">&#x27;</span><span style="color:#A3BE8C">|</span><span style="color:#ECEFF4">&#x27;</span><span style="color:#ECEFF4">)</span><span style="color:#ECEFF4">}`</span><span style="color:#81A1C1">;</span></span>
<span class="line"><span style="color:#D8DEE9FF">  </span></span>
<span class="line"><span style="color:#ECEFF4">  </span><span style="color:#616E88">// 出现循环依赖，不考虑单独打包 </span></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#81A1C1">if</span><span style="color:#D8DEE9FF"> (</span><span style="color:#D8DEE9">importChain</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">includes</span><span style="color:#D8DEE9FF">(</span><span style="color:#D8DEE9">id</span><span style="color:#D8DEE9FF">)) </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#D8DEE9">cache</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">set</span><span style="color:#D8DEE9FF">(</span><span style="color:#D8DEE9">key</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">false</span><span style="color:#D8DEE9FF">)</span><span style="color:#81A1C1">;</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#81A1C1">return</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">false;</span></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#ECEFF4">}</span></span>
<span class="line"><span style="color:#D8DEE9FF">  </span></span>
<span class="line"><span style="color:#ECEFF4">  </span><span style="color:#616E88">// 验证缓存，如果缓存中已记录该路径，则直接返回结果</span></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#81A1C1">if</span><span style="color:#D8DEE9FF"> (</span><span style="color:#D8DEE9">cache</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">has</span><span style="color:#D8DEE9FF">(</span><span style="color:#D8DEE9">key</span><span style="color:#D8DEE9FF">)) </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#81A1C1">return</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">cache</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">get</span><span style="color:#D8DEE9FF">(</span><span style="color:#D8DEE9">key</span><span style="color:#D8DEE9FF">)</span><span style="color:#81A1C1">;</span></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#ECEFF4">}</span></span>
<span class="line"><span style="color:#D8DEE9FF">  </span></span>
<span class="line"><span style="color:#ECEFF4">  </span><span style="color:#616E88">// 命中依赖列表，说明当前模块是被chunkGroups中声明的包所引用的</span></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#81A1C1">if</span><span style="color:#D8DEE9FF"> (</span><span style="color:#D8DEE9">depPaths</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">includes</span><span style="color:#D8DEE9FF">(</span><span style="color:#D8DEE9">id</span><span style="color:#D8DEE9FF">)) </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#ECEFF4">    </span><span style="color:#616E88">// 引用链中的文件都记录到缓存中，表示已经验证过的依赖路径</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#D8DEE9">importChain</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">forEach</span><span style="color:#D8DEE9FF">(</span><span style="color:#D8DEE9">item</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=&gt;</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">cache</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">set</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">`${</span><span style="color:#D8DEE9">item</span><span style="color:#ECEFF4">}</span><span style="color:#A3BE8C">-</span><span style="color:#ECEFF4">${</span><span style="color:#D8DEE9">depPaths</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">join</span><span style="color:#ECEFF4">(</span><span style="color:#ECEFF4">&#x27;</span><span style="color:#A3BE8C">|</span><span style="color:#ECEFF4">&#x27;</span><span style="color:#ECEFF4">)</span><span style="color:#ECEFF4">}`</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">true</span><span style="color:#D8DEE9FF">))</span><span style="color:#81A1C1">;</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#81A1C1">return</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">true;</span></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#ECEFF4">}</span></span>
<span class="line"><span style="color:#D8DEE9FF">  </span></span>
<span class="line"><span style="color:#ECEFF4">  </span><span style="color:#616E88">// 获取当前模块的详细信息</span></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#81A1C1">const</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">moduleInfo</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> </span><span style="color:#88C0D0">getModuleInfo</span><span style="color:#D8DEE9FF">(</span><span style="color:#D8DEE9">id</span><span style="color:#D8DEE9FF">)</span><span style="color:#81A1C1">;</span></span>
<span class="line"><span style="color:#D8DEE9FF">  </span></span>
<span class="line"><span style="color:#ECEFF4">  </span><span style="color:#616E88">// 如果模块信息不存在或者importers为空，则直接返回false，表示不是循环依赖</span></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#81A1C1">if</span><span style="color:#D8DEE9FF"> (</span><span style="color:#81A1C1">!</span><span style="color:#D8DEE9">moduleInfo</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">||</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">!</span><span style="color:#D8DEE9">moduleInfo</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">importers</span><span style="color:#D8DEE9FF">) </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#D8DEE9">cache</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">set</span><span style="color:#D8DEE9FF">(</span><span style="color:#D8DEE9">key</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">false</span><span style="color:#D8DEE9FF">)</span><span style="color:#81A1C1">;</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#81A1C1">return</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">false;</span></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#ECEFF4">}</span></span>
<span class="line"><span style="color:#D8DEE9FF">  </span></span>
<span class="line"><span style="color:#ECEFF4">  </span><span style="color:#616E88">// 核心逻辑，递归查找上层引用者，看是否存在循环依赖</span></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#81A1C1">const</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">isInclude</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">moduleInfo</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">importers</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">some</span><span style="color:#D8DEE9FF">(</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#D8DEE9">importer</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=&gt;</span><span style="color:#D8DEE9FF"> </span><span style="color:#88C0D0">isDepInclude</span><span style="color:#D8DEE9FF">(</span><span style="color:#D8DEE9">importer</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">depPaths</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">importChain</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">concat</span><span style="color:#D8DEE9FF">(</span><span style="color:#D8DEE9">id</span><span style="color:#D8DEE9FF">)</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">getModuleInfo</span><span style="color:#D8DEE9FF">)</span></span>
<span class="line"><span style="color:#D8DEE9FF">  )</span><span style="color:#81A1C1">;</span></span>
<span class="line"><span style="color:#D8DEE9FF">  </span></span>
<span class="line"><span style="color:#ECEFF4">  </span><span style="color:#616E88">// 设置缓存，记录当前依赖路径的结果</span></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#D8DEE9">cache</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">set</span><span style="color:#D8DEE9FF">(</span><span style="color:#D8DEE9">key</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">isInclude</span><span style="color:#D8DEE9FF">)</span><span style="color:#81A1C1">;</span></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#81A1C1">return</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">isInclude</span><span style="color:#81A1C1">;</span></span>
<span class="line"><span style="color:#ECEFF4">}</span></span>
<span class="line"></span>
<span class="line"></span></code></pre></div>
<ul>
<li><code>moduleInfo.importers</code>可以拿到模块引用者 针对每个引用者递归操作 从而获取引用链信息</li>
<li>尽量使用缓存 第三方包模块数量较多</li>
</ul>
<p>安装插件</p>
<div class="language-typescript"><span class="lang">typescript</span><pre class="shiki" style="background-color:#2e3440ff"><code><span class="line"><span style="color:#D8DEE9">pnpm</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">i</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">vite</span><span style="color:#81A1C1">-</span><span style="color:#D8DEE9">plugin</span><span style="color:#81A1C1">-</span><span style="color:#D8DEE9">chunk</span><span style="color:#81A1C1">-</span><span style="color:#D8DEE9">split</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">-</span><span style="color:#D8DEE9">D</span></span>
<span class="line"></span></code></pre></div>
<p>引用</p>
<div class="language-typescript"><span class="lang">typescript</span><pre class="shiki" style="background-color:#2e3440ff"><code><span class="line"><span style="color:#616E88">// vite.config.ts</span></span>
<span class="line"><span style="color:#81A1C1">import</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">chunkSplitPlugin</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">}</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">from</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">&#x27;</span><span style="color:#A3BE8C">vite-plugin-chunk-split</span><span style="color:#ECEFF4">&#x27;</span><span style="color:#81A1C1">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1">export</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">default</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#88C0D0">chunkSplitPlugin</span><span style="color:#ECEFF4">({</span></span>
<span class="line"><span style="color:#ECEFF4">    </span><span style="color:#616E88">// 指定拆包策略</span></span>
<span class="line"><span style="color:#D8DEE9FF">    customSplitting</span><span style="color:#ECEFF4">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#ECEFF4">      </span><span style="color:#616E88">// 1. 支持填包名。`react` 和 `react-dom` 会被打包到一个名为`render-vendor`的 chunk 里面(包括它们的依赖，如 object-assign)</span></span>
<span class="line"><span style="color:#D8DEE9FF">      </span><span style="color:#ECEFF4">&#x27;</span><span style="color:#A3BE8C">react-vendor</span><span style="color:#ECEFF4">&#x27;</span><span style="color:#ECEFF4">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">[</span><span style="color:#ECEFF4">&#x27;</span><span style="color:#A3BE8C">react</span><span style="color:#ECEFF4">&#x27;</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">&#x27;</span><span style="color:#A3BE8C">react-dom</span><span style="color:#ECEFF4">&#x27;</span><span style="color:#ECEFF4">],</span></span>
<span class="line"><span style="color:#ECEFF4">      </span><span style="color:#616E88">// 2. 支持填正则表达式。src 中 components 和 utils 下的所有文件被会被打包为`component-util`的 chunk 中</span></span>
<span class="line"><span style="color:#D8DEE9FF">      </span><span style="color:#ECEFF4">&#x27;</span><span style="color:#A3BE8C">components-util</span><span style="color:#ECEFF4">&#x27;</span><span style="color:#ECEFF4">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">[</span><span style="color:#ECEFF4">/</span><span style="color:#EBCB8B">src\/components</span><span style="color:#ECEFF4">/</span><span style="color:#ECEFF4">,</span><span style="color:#EBCB8B"> </span><span style="color:#ECEFF4">/</span><span style="color:#EBCB8B">src\/utils</span><span style="color:#ECEFF4">/</span><span style="color:#ECEFF4">]</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#ECEFF4">}</span></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#ECEFF4">})</span></span>
<span class="line"><span style="color:#ECEFF4">}</span></span>
<span class="line"></span></code></pre></div>
<hr/>
<p></p>
<h2 id="ssr"><a class="header-anchor" href="#ssr">#</a>ssr</h2>
<p><img src="https://cdn.nlark.com/yuque/0/2024/jpeg/12610297/1705386969796-1110d194-86a5-4e37-b7ed-0c8d7be1211f.jpeg" alt=""/></p></div><footer mt="8"><div flex="~" gap="2" divider-top="~" pt="6"><div flex="~ col" class="_prev_kdbcv_1"><a href="/guide/Counter" class="_pager-link_kdbcv_6"><span class="_desc_kdbcv_29">上一页</span><span class="_title_kdbcv_20">normal</span></a></div><div flex="~ col" class="_next_kdbcv_2"><a href="/guide/d" class="_pager-link_kdbcv_6 _next_kdbcv_2"><span class="_desc_kdbcv_29">下一页</span><span class="_title_kdbcv_20">test</span></a></div></div></footer></div></div><div relative="~" display="none lg:block" order="2" flex="1" p="l-8" class="max-w-256px"><div class="_aside-container_aof7m_32"><div flex="~ col" p="b-8" style="min-height:calc(100vh - (var(--island-nav-height-desktop) + 32px))"><div __island="Aside:0"><div flex="~ col 1" style="width:var(--nasuke-aside-width)"><div><div id="aside-container" class="relative divider-left pl-4 text-13px font-medium"><div id="aside-marker" class="absolute top-33px opacity-0 w-1px h-18px bg-brand" style="left:-1px;transition:top 0.25s cubic-bezier(0, 1, 0.5, 1), background-color 0.5s, opacity 0.25s"></div><div leading-7="~" text="13px" font="semibold">ON THIS PAGE</div><nav><ul relative="~"><li><a href="#vite插件系统中独有的hook" class="block leading-7 text-text-2 hover:text-text-1" transition="color duration-300" style="padding-left:0">Vite插件系统中独有的hook</a></li><li><a href="#config---丰富配置" class="block leading-7 text-text-2 hover:text-text-1" transition="color duration-300" style="padding-left:12px">config - 丰富配置</a></li><li><a href="#configresolved---记录最终配置" class="block leading-7 text-text-2 hover:text-text-1" transition="color duration-300" style="padding-left:12px">configResolved - 记录最终配置</a></li><li><a href="#configureserver---获取devserver实例" class="block leading-7 text-text-2 hover:text-text-1" transition="color duration-300" style="padding-left:12px">configureServer - 获取DevServer实例</a></li><li><a href="#transformindexhtml---控制html内容" class="block leading-7 text-text-2 hover:text-text-1" transition="color duration-300" style="padding-left:12px">transformIndexHtml - 控制HTML内容</a></li><li><a href="#handlehotupdate---热更新处理" class="block leading-7 text-text-2 hover:text-text-1" transition="color duration-300" style="padding-left:12px">handleHotUpdate - 热更新处理</a></li><li><a href="#插件执行顺序" class="block leading-7 text-text-2 hover:text-text-1" transition="color duration-300" style="padding-left:0">插件执行顺序</a></li><li><a href="#插件应用位置" class="block leading-7 text-text-2 hover:text-text-1" transition="color duration-300" style="padding-left:0">插件应用位置</a></li><li><a href="#实战" class="block leading-7 text-text-2 hover:text-text-1" transition="color duration-300" style="padding-left:0">实战</a></li><li><a href="#虚拟模块" class="block leading-7 text-text-2 hover:text-text-1" transition="color duration-300" style="padding-left:12px">虚拟模块</a></li><li><a href="#vite热更新" class="block leading-7 text-text-2 hover:text-text-1" transition="color duration-300" style="padding-left:0">Vite热更新</a></li><li><a href="#更新逻辑-hotaccept" class="block leading-7 text-text-2 hover:text-text-1" transition="color duration-300" style="padding-left:12px">更新逻辑 hot.accept</a></li><li><a href="#旧模块销毁处理副作用-hotdispose" class="block leading-7 text-text-2 hover:text-text-1" transition="color duration-300" style="padding-left:12px">旧模块销毁处理副作用 hot.dispose</a></li><li><a href="#共享数据-hotdata" class="block leading-7 text-text-2 hover:text-text-1" transition="color duration-300" style="padding-left:12px">共享数据 hot.data</a></li><li><a href="#vite产物构建" class="block leading-7 text-text-2 hover:text-text-1" transition="color duration-300" style="padding-left:0">Vite产物构建</a></li><li><a href="#vite默认拆包策略" class="block leading-7 text-text-2 hover:text-text-1" transition="color duration-300" style="padding-left:12px">Vite默认拆包策略</a></li><li><a href="#自定义拆包" class="block leading-7 text-text-2 hover:text-text-1" transition="color duration-300" style="padding-left:12px">自定义拆包</a></li><li><a href="#解决循环依赖" class="block leading-7 text-text-2 hover:text-text-1" transition="color duration-300" style="padding-left:12px">解决循环依赖</a></li><li><a href="#ssr" class="block leading-7 text-text-2 hover:text-text-1" transition="color duration-300" style="padding-left:0">ssr</a></li></ul></nav></div></div></div></div></div></div></div></div></div></section></div></div>
    <script type="module">import{jsx as p,jsxs as _}from"react/jsx-runtime";import{useState as G,useEffect as $,useRef as M}from"react";var D=typeof global=="object"&&global&&global.Object===Object&&global;const F=D;var U=typeof self=="object"&&self&&self.Object===Object&&self,q=F||U||Function("return this")();const R=q;var X=R.Symbol;const v=X;var B=Object.prototype,Y=B.hasOwnProperty,z=B.toString,y=v?v.toStringTag:void 0;function J(e){var t=Y.call(e,y),r=e[y];try{e[y]=void 0;var i=!0}catch{}var s=z.call(e);return i&&(t?e[y]=r:delete e[y]),s}var V=Object.prototype,K=V.toString;function Q(e){return K.call(e)}var Z="[object Null]",ee="[object Undefined]",A=v?v.toStringTag:void 0;function te(e){return e==null?e===void 0?ee:Z:A&&A in Object(e)?J(e):Q(e)}function ne(e){return e!=null&&typeof e=="object"}var re="[object Symbol]";function ie(e){return typeof e=="symbol"||ne(e)&&te(e)==re}var oe=/\s/;function ce(e){for(var t=e.length;t--&&oe.test(e.charAt(t)););return t}var ae=/^\s+/;function se(e){return e&&e.slice(0,ce(e)+1).replace(ae,"")}function x(e){var t=typeof e;return e!=null&&(t=="object"||t=="function")}var N=0/0,le=/^[-+]0x[0-9a-f]+$/i,de=/^0b[01]+$/i,fe=/^0o[0-7]+$/i,ue=parseInt;function L(e){if(typeof e=="number")return e;if(ie(e))return N;if(x(e)){var t=typeof e.valueOf=="function"?e.valueOf():e;e=x(t)?t+"":t}if(typeof e!="string")return e===0?e:+e;e=se(e);var r=de.test(e);return r||fe.test(e)?ue(e.slice(2),r?2:8):le.test(e)?N:+e}var me=function(){return R.Date.now()};const w=me;var ge="Expected a function",pe=Math.max,be=Math.min;function he(e,t,r){var i,s,l,o,n,a,d=0,m=!1,f=!1,b=!0;if(typeof e!="function")throw new TypeError(ge);t=L(t)||0,x(r)&&(m=!!r.leading,f="maxWait"in r,l=f?pe(L(r.maxWait)||0,t):l,b="trailing"in r?!!r.trailing:b);function S(c){var g=i,h=s;return i=s=void 0,d=c,o=e.apply(h,g),o}function H(c){return d=c,n=setTimeout(T,t),m?S(c):o}function C(c){var g=c-a,h=c-d,O=t-g;return f?be(O,l-h):O}function I(c){var g=c-a,h=c-d;return a===void 0||g>=t||g<0||f&&h>=l}function T(){var c=w();if(I(c))return j(c);n=setTimeout(T,C(c))}function j(c){return n=void 0,b&&i?S(c):(i=s=void 0,o)}function P(){n!==void 0&&clearTimeout(n),d=0,i=a=s=n=void 0}function W(){return n===void 0?o:j(w())}function E(){var c=w(),g=I(c);if(i=arguments,s=this,a=c,g){if(n===void 0)return H(a);if(f)return clearTimeout(n),n=setTimeout(T,t),S(a)}return n===void 0&&(n=setTimeout(T,t)),o}return E.cancel=P,E.flush=W,E}var ye="Expected a function";function Te(e,t,r){var i=!0,s=!0;if(typeof e!="function")throw new TypeError(ye);return x(r)&&(i="leading"in r?!!r.leading:i,s="trailing"in r?!!r.trailing:s),he(e,t,{leading:i,maxWait:t,trailing:s})}let u=[];const k=56;function ve(e,t){const r=parseInt(window.getComputedStyle(e).paddingTop,10),i=window.scrollY+e.getBoundingClientRect().top+r-k;window.scrollTo({left:0,top:i,behavior:t?"smooth":"auto"})}function xe(){const e=document.getElementById("aside-marker"),t=document.getElementById("aside-container"),r=Array.from((t==null?void 0:t.getElementsByTagName("a"))||[]).map(o=>decodeURIComponent(o.hash));if(!t)return;const i=(o,n)=>{if(o[n]){const a=o[n].getAttribute("href"),d=r.findIndex(f=>f===a);(t==null?void 0:t.querySelector(`a[href="#${a.slice(1)}"]`))&&(e.style.top=`${33+d*28}px`,e.style.opacity="1")}},l=Te(()=>{if(u=Array.from(document.querySelectorAll(".nasuke-doc .header-anchor")).filter(n=>{var a;return((a=n.parentElement)==null?void 0:a.tagName)!=="H1"}),document.documentElement.scrollTop+window.innerHeight>=document.documentElement.scrollHeight){i(u,u.length-1);return}for(let n=0;n<u.length;n++){const a=u[n],d=u[n+1],m=Math.ceil(window.scrollY),f=a.parentElement.offsetTop-k;if(!d){i(u,n);break}if(n===0&&m<f||m==0){i(u,0);break}const b=d.parentElement.offsetTop-k;if(m>=f&&m<b){i(u,n);break}}},100);return window.addEventListener("scroll",l),()=>{window.removeEventListener("scroll",l)}}function Se(e){const[t,r]=G(e);return $(()=>{}),t}function Ee(e){const{headers:t=[]}=e,r=Se(t),i=r.length>0,s=M(null);$(()=>{const o=xe();return()=>{o()}},[]);const l=o=>p("li",{children:p("a",{href:`#${o.id}`,className:"block leading-7 text-text-2 hover:text-text-1",transition:"color duration-300",style:{paddingLeft:(o.depth-2)*12},onClick:n=>{n.preventDefault();const a=document.getElementById(o.id);a&&ve(a,!1)},children:o.text})},o.id);return p("div",{flex:"~ col 1",style:{width:"var(--nasuke-aside-width)"},children:p("div",{children:i&&_("div",{id:"aside-container",className:"relative divider-left pl-4 text-13px font-medium",children:[p("div",{ref:s,id:"aside-marker",className:"absolute top-33px opacity-0 w-1px h-18px bg-brand",style:{left:"-1px",transition:"top 0.25s cubic-bezier(0, 1, 0.5, 1), background-color 0.5s, opacity 0.25s"}}),p("div",{"leading-7":"~",text:"13px",font:"semibold",children:"ON THIS PAGE"}),p("nav",{children:p("ul",{relative:"~",children:r.map(l)})})]})})})}window.ISLANDS={Aside:Ee};window.ISLAND_PROPS=JSON.parse(document.getElementById("island-props").textContent);
</script>
    <script type="module" src="/assets/client-entry.45e1b34b.js"></script>
    <script id="island-props">[{"headers":[{"id":"vite插件系统中独有的hook","text":"Vite插件系统中独有的hook","depth":2},{"id":"config---丰富配置","text":"config - 丰富配置","depth":3},{"id":"configresolved---记录最终配置","text":"configResolved - 记录最终配置","depth":3},{"id":"configureserver---获取devserver实例","text":"configureServer - 获取DevServer实例","depth":3},{"id":"transformindexhtml---控制html内容","text":"transformIndexHtml - 控制HTML内容","depth":3},{"id":"handlehotupdate---热更新处理","text":"handleHotUpdate - 热更新处理","depth":3},{"id":"插件执行顺序","text":"插件执行顺序","depth":2},{"id":"插件应用位置","text":"插件应用位置","depth":2},{"id":"实战","text":"实战","depth":2},{"id":"虚拟模块","text":"虚拟模块","depth":3},{"id":"vite热更新","text":"Vite热更新","depth":2},{"id":"更新逻辑-hotaccept","text":"更新逻辑 hot.accept","depth":3},{"id":"旧模块销毁处理副作用-hotdispose","text":"旧模块销毁处理副作用 hot.dispose","depth":3},{"id":"共享数据-hotdata","text":"共享数据 hot.data","depth":3},{"id":"vite产物构建","text":"Vite产物构建","depth":2},{"id":"vite默认拆包策略","text":"Vite默认拆包策略","depth":3},{"id":"自定义拆包","text":"自定义拆包","depth":3},{"id":"解决循环依赖","text":"解决循环依赖","depth":3},{"id":"ssr","text":"ssr","depth":2}]}]</script>
  </body>
</html>